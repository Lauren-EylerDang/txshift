<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IPCW-TMLEs with Stochastic Treatment Regimes • txshift</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/readable/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="IPCW-TMLEs with Stochastic Treatment Regimes">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">txshift</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/intro_txshift.html">Targeted Learning with Stochastic Treatment Regimes</a>
    </li>
    <li>
      <a href="../articles/ipcw_txshift.html">IPCW-TMLEs with Stochastic Treatment Regimes</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/nhejazi/txshift">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>IPCW-TMLEs with Stochastic Treatment Regimes</h1>
                        <h4 class="author">
<a href="https://nimahejazi.org">Nima Hejazi</a> and <a href="https://www.benkeserstatistics.com/">David Benkeser</a>
</h4>
            
            <h4 class="date">2019-03-31</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/nhejazi/txshift/blob/master/vignettes/ipcw_txshift.Rmd"><code>vignettes/ipcw_txshift.Rmd</code></a></small>
      <div class="hidden name"><code>ipcw_txshift.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>For a more general introduction to the targeted maximum likelihood estimator introduced in <span class="citation">Díaz and van der Laan (2018)</span> and the corresponding software implementation found in this package, a better resource to consult is the introductory vignette. This document builds on that work, describing an inverse probability of censoring weighted TML estimator (IPCW-TMLE) for the same target parameter when a censoring process is introduced into the observed data structure. In this case the observed data structure may be denoted <span class="math inline">\(O = (W, \Delta A, Y)\)</span>, where <span class="math inline">\(W\)</span> is a set of baseline covariates, <span class="math inline">\(A\)</span> is a continuous-valued treatment or intervention, <span class="math inline">\(Y\)</span> is an outcome of interest, and <span class="math inline">\(\Delta\)</span> is an indicator of missingness (<span class="math inline">\(1\)</span> corresponding to being observed, <span class="math inline">\(0\)</span> to being missing). Perhaps the best way to appreciate the utilities provided for computing IPCW-TMLEs in this R package is to work through examples, so let’s simply jump to that.</p>
<p>To start, let’s load the packages we’ll use and set a seed for simulation:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tidyverse)</a></code></pre></div>
<pre><code>## ── Attaching packages ────────────────────────────────── tidyverse 1.2.1 ──</code></pre>
<pre><code>## ✔ ggplot2 3.1.0       ✔ purrr   0.3.2  
## ✔ tibble  2.1.1       ✔ dplyr   0.8.0.1
## ✔ tidyr   0.8.3       ✔ stringr 1.4.0  
## ✔ readr   1.3.1       ✔ forcats 0.4.0</code></pre>
<pre><code>## ── Conflicts ───────────────────────────────────── tidyverse_conflicts() ──
## ✖ dplyr::filter() masks stats::filter()
## ✖ dplyr::lag()    masks stats::lag()</code></pre>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(data.table)</a></code></pre></div>
<pre><code>## 
## Attaching package: 'data.table'</code></pre>
<pre><code>## The following objects are masked from 'package:dplyr':
## 
##     between, first, last</code></pre>
<pre><code>## The following object is masked from 'package:purrr':
## 
##     transpose</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(haldensify)</a></code></pre></div>
<pre><code>## haldensify v0.0.3: Conditional Density Estimation with the Highly Adaptive Lasso</code></pre>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(sl3)</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(txshift)</a></code></pre></div>
<pre><code>## txshift v0.2.3: Targeted Learning of the Causal Effects of Stochastic Interventions</code></pre>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Random">set.seed</a></span>(<span class="dv">429153</span>)</a></code></pre></div>
<hr>
</div>
<div id="data-and-notation" class="section level2">
<h2 class="hasAnchor">
<a href="#data-and-notation" class="anchor"></a>Data and Notation</h2>
<ol style="list-style-type: decimal">
<li><p>Start with a simple additive shift – i.e., <span class="math inline">\(d(a,w) = a + \delta\)</span> if <span class="math inline">\(a \leq u(w) - \delta\)</span> or <span class="math inline">\(d(a, w) = a\)</span> if <span class="math inline">\(a \geq u(w) - \delta\)</span>.</p></li>
<li><p>The additive shift will have support everywhere – i.e., <span class="math inline">\(a \leq u(w)\)</span> is true everywhere.</p></li>
<li><p>Consider the case in which some observations are missing — for now, let us consider a simple case-control sampling case wherein the treatment is partially censored. Let us denote the sampling/censoring mechanism <span class="math inline">\(\Delta\)</span>, and let <span class="math inline">\(1\)</span> correspond to being observed and <span class="math inline">\(0\)</span> to being missing.</p></li>
<li><p>The data structure that we now observe is <span class="math inline">\(O = (W, \Delta A, Y)\)</span>.</p></li>
</ol>
<div id="simulate-data" class="section level3">
<h3 class="hasAnchor">
<a href="#simulate-data" class="anchor"></a>Simulate Data</h3>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="co"># simulate simple data for tmle-shift sketch</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2">n_obs &lt;-<span class="st"> </span><span class="dv">1000</span>  <span class="co"># sample size</span></a>
<a class="sourceLine" id="cb14-3" data-line-number="3">n_w &lt;-<span class="st"> </span><span class="dv">1</span>  <span class="co"># just one baseline covariate for this example</span></a>
<a class="sourceLine" id="cb14-4" data-line-number="4">tx_mult &lt;-<span class="st"> </span><span class="dv">2</span>  <span class="co"># multiplier for the effect of W = 1 on the treatment</span></a>
<a class="sourceLine" id="cb14-5" data-line-number="5"></a>
<a class="sourceLine" id="cb14-6" data-line-number="6"><span class="co"># baseline covariate -- simple, binary</span></a>
<a class="sourceLine" id="cb14-7" data-line-number="7">W &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">replicate</a></span>(n_w, <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Binomial">rbinom</a></span>(n_obs, <span class="dv">1</span>, <span class="fl">0.5</span>)))</a>
<a class="sourceLine" id="cb14-8" data-line-number="8"></a>
<a class="sourceLine" id="cb14-9" data-line-number="9"><span class="co"># set and organize treatment based on baseline W</span></a>
<a class="sourceLine" id="cb14-10" data-line-number="10">A &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(n_obs, <span class="dt">mean =</span> tx_mult <span class="op">*</span><span class="st"> </span>W, <span class="dt">sd =</span> <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb14-11" data-line-number="11"></a>
<a class="sourceLine" id="cb14-12" data-line-number="12"><span class="co"># create outcome as linear function of A, W + white noise</span></a>
<a class="sourceLine" id="cb14-13" data-line-number="13">Y &lt;-<span class="st"> </span>A <span class="op">+</span><span class="st"> </span>W <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(n_obs, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb14-14" data-line-number="14"></a>
<a class="sourceLine" id="cb14-15" data-line-number="15"><span class="co"># censoring based on covariates</span></a>
<a class="sourceLine" id="cb14-16" data-line-number="16">C &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Binomial">rbinom</a></span>(n_obs, <span class="dv">1</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Logistic">plogis</a></span>(W))</a>
<a class="sourceLine" id="cb14-17" data-line-number="17"></a>
<a class="sourceLine" id="cb14-18" data-line-number="18"><span class="co"># treatment shift parameter</span></a>
<a class="sourceLine" id="cb14-19" data-line-number="19">delta &lt;-<span class="st"> </span><span class="fl">0.5</span></a></code></pre></div>
<hr>
</div>
</div>
<div id="methodology" class="section level2">
<h2 class="hasAnchor">
<a href="#methodology" class="anchor"></a>Methodology</h2>
<p><strong>Note:</strong> In all examples below, the argument <code>eif_reg_type</code> is set to <code>"glm"</code> (whereas the default is <code>"hal"</code>) when invoking an IPCW-TMLE. This is done in an effort to speed along the computation process, as this argument controls the manner in which a nuisance regression associated with the efficient influence function of the IPCW-TMLE is fit. As stated in the documentation, setting this argument to <code>"glm"</code> fits this EIF nuisance regression with a generalized linear model (GLM; an assumption-laden parametric form) while the default value of <code>"hal"</code> fits the nuisance regression with the highly adaptive lasso (HAL; a recently developed nonparametric estimator) via the <a href="https://github.com/tlverse/hal9001"><code>hal9001</code> R package</a>. In practice, we recommend leaving this argument to the default and fitting the EIF nuisance regression with HAL; however, this is significantly slower than simple using a GLM.</p>
<div id="inverse-probability-weighting-with-targeted-maximum-likelihood-estimation" class="section level3">
<h3 class="hasAnchor">
<a href="#inverse-probability-weighting-with-targeted-maximum-likelihood-estimation" class="anchor"></a>Inverse Probability Weighting with Targeted Maximum Likelihood Estimation</h3>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">tmle_hal_shift_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw"><a href="../reference/txshift.html">txshift</a></span>(<span class="dt">W =</span> W, <span class="dt">A =</span> A, <span class="dt">Y =</span> Y,</a>
<a class="sourceLine" id="cb15-2" data-line-number="2">                            <span class="dt">C =</span> C, <span class="dt">V =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"W"</span>, <span class="st">"Y"</span>),</a>
<a class="sourceLine" id="cb15-3" data-line-number="3">                            <span class="dt">delta =</span> delta,</a>
<a class="sourceLine" id="cb15-4" data-line-number="4">                            <span class="dt">fluc_method =</span> <span class="st">"standard"</span>,</a>
<a class="sourceLine" id="cb15-5" data-line-number="5">                            <span class="dt">max_iter =</span> <span class="dv">2</span>,</a>
<a class="sourceLine" id="cb15-6" data-line-number="6">                            <span class="dt">ipcw_fit_args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"glm"</span>),</a>
<a class="sourceLine" id="cb15-7" data-line-number="7">                            <span class="dt">g_fit_args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"hal"</span>,</a>
<a class="sourceLine" id="cb15-8" data-line-number="8">                                              <span class="dt">n_bins =</span> <span class="dv">5</span>,</a>
<a class="sourceLine" id="cb15-9" data-line-number="9">                                              <span class="dt">grid_type =</span> <span class="st">"equal_mass"</span>,</a>
<a class="sourceLine" id="cb15-10" data-line-number="10">                                              <span class="dt">lambda_seq =</span></a>
<a class="sourceLine" id="cb15-11" data-line-number="11">                                                <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">-9</span>,</a>
<a class="sourceLine" id="cb15-12" data-line-number="12">                                                        <span class="dt">length =</span> <span class="dv">300</span>))),</a>
<a class="sourceLine" id="cb15-13" data-line-number="13">                            <span class="dt">Q_fit_args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"glm"</span>,</a>
<a class="sourceLine" id="cb15-14" data-line-number="14">                                              <span class="dt">glm_formula =</span> <span class="st">"Y ~ ."</span>),</a>
<a class="sourceLine" id="cb15-15" data-line-number="15">                            <span class="dt">eif_reg_type =</span> <span class="st">"glm"</span></a>
<a class="sourceLine" id="cb15-16" data-line-number="16">                           )</a>
<a class="sourceLine" id="cb15-17" data-line-number="17"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(tmle_hal_shift_<span class="dv">1</span>)</a></code></pre></div>
<pre><code>##       lwr_ci    param_est       upr_ci    param_var     eif_mean 
##      1.92117      2.07943      2.23769      0.00652 -9.34184e-04 
##    estimator       n_iter 
##         tmle            1</code></pre>
<p>When computing any such TML estimator, we may, of course, vary the regressions used in fitting the nuisance parameters; however, an even simpler variation is to fit the step for the fluctuation submodels with a <em>weighted</em> method, simply weighting each observation by an auxiliary covariate (often denoted <span class="math inline">\(H_n\)</span>, and sometimes called the “clever covariate” in the literature) rather than using such a covariate directly in the submodel regression fit.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1">tmle_hal_shift_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw"><a href="../reference/txshift.html">txshift</a></span>(<span class="dt">W =</span> W, <span class="dt">A =</span> A, <span class="dt">Y =</span> Y,</a>
<a class="sourceLine" id="cb17-2" data-line-number="2">                            <span class="dt">C =</span> C, <span class="dt">V =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"W"</span>, <span class="st">"Y"</span>),</a>
<a class="sourceLine" id="cb17-3" data-line-number="3">                            <span class="dt">delta =</span> delta,</a>
<a class="sourceLine" id="cb17-4" data-line-number="4">                            <span class="dt">fluc_method =</span> <span class="st">"weighted"</span>,</a>
<a class="sourceLine" id="cb17-5" data-line-number="5">                            <span class="dt">max_iter =</span> <span class="dv">2</span>,</a>
<a class="sourceLine" id="cb17-6" data-line-number="6">                            <span class="dt">ipcw_fit_args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"glm"</span>),</a>
<a class="sourceLine" id="cb17-7" data-line-number="7">                            <span class="dt">g_fit_args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"hal"</span>,</a>
<a class="sourceLine" id="cb17-8" data-line-number="8">                                              <span class="dt">n_bins =</span> <span class="dv">5</span>,</a>
<a class="sourceLine" id="cb17-9" data-line-number="9">                                              <span class="dt">grid_type =</span> <span class="st">"equal_mass"</span>,</a>
<a class="sourceLine" id="cb17-10" data-line-number="10">                                              <span class="dt">lambda_seq =</span></a>
<a class="sourceLine" id="cb17-11" data-line-number="11">                                                <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">-9</span>,</a>
<a class="sourceLine" id="cb17-12" data-line-number="12">                                                        <span class="dt">length =</span> <span class="dv">300</span>))),</a>
<a class="sourceLine" id="cb17-13" data-line-number="13">                            <span class="dt">Q_fit_args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"glm"</span>,</a>
<a class="sourceLine" id="cb17-14" data-line-number="14">                                              <span class="dt">glm_formula =</span> <span class="st">"Y ~ ."</span>),</a>
<a class="sourceLine" id="cb17-15" data-line-number="15">                            <span class="dt">eif_reg_type =</span> <span class="st">"glm"</span></a>
<a class="sourceLine" id="cb17-16" data-line-number="16">                           )</a>
<a class="sourceLine" id="cb17-17" data-line-number="17"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(tmle_hal_shift_<span class="dv">2</span>)</a></code></pre></div>
<pre><code>##       lwr_ci    param_est       upr_ci    param_var     eif_mean 
##       1.9235      2.08134      2.23917      0.00648 -9.35742e-04 
##    estimator       n_iter 
##         tmle            1</code></pre>
</div>
<div id="interlude-constructing-optimal-stacked-regressions-with-sl3" class="section level3">
<h3 class="hasAnchor">
<a href="#interlude-constructing-optimal-stacked-regressions-with-sl3" class="anchor"></a>Interlude: Constructing Optimal Stacked Regressions with <code>sl3</code>
</h3>
<p>To easily incorporate ensemble machine learning into the estimation procedure, we rely on the facilities provided in the <a href="https://sl3.tlverse.org"><code>sl3</code> R package</a>. For a complete guide on using the <code>sl3</code> R package, consider consulting <a href="https://sl3.tlverse.org" class="uri">https://sl3.tlverse.org</a>, or <a href="https://tlverse.org" class="uri">https://tlverse.org</a> for the <code>tlverse</code> ecosystem, of which <code>sl3</code> is a major part.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="co"># SL learners to be used for most fits (e.g., IPCW, outcome regression)</span></a>
<a class="sourceLine" id="cb19-2" data-line-number="2">lrnr_lib &lt;-<span class="st"> </span><span class="kw"><a href="https://tlverse.org/sl3/reference/make_learner_stack.html">make_learner_stack</a></span>(<span class="st">"Lrnr_mean"</span>, <span class="st">"Lrnr_glm_fast"</span>, <span class="st">"Lrnr_ranger"</span>)</a>
<a class="sourceLine" id="cb19-3" data-line-number="3">sl_lrn &lt;-<span class="st"> </span>Lrnr_sl<span class="op">$</span><span class="kw">new</span>(<span class="dt">learners =</span> lrnr_lib, <span class="dt">metalearner =</span> Lrnr_nnls<span class="op">$</span><span class="kw">new</span>())</a>
<a class="sourceLine" id="cb19-4" data-line-number="4"></a>
<a class="sourceLine" id="cb19-5" data-line-number="5"><span class="co"># SL learners for conditional densities to be used for the propensity score fit</span></a>
<a class="sourceLine" id="cb19-6" data-line-number="6">lrnr_dens_lib &lt;-<span class="st"> </span><span class="kw"><a href="https://tlverse.org/sl3/reference/make_learner_stack.html">make_learner_stack</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="st">"Lrnr_condensier"</span>, <span class="dt">nbins =</span> <span class="dv">35</span>,</a>
<a class="sourceLine" id="cb19-7" data-line-number="7">                                          <span class="dt">bin_estimator =</span> Lrnr_glm_fast<span class="op">$</span><span class="kw">new</span>(),</a>
<a class="sourceLine" id="cb19-8" data-line-number="8">                                          <span class="dt">bin_method =</span> <span class="st">"equal.len"</span>,</a>
<a class="sourceLine" id="cb19-9" data-line-number="9">                                          <span class="dt">pool =</span> <span class="ot">FALSE</span>),</a>
<a class="sourceLine" id="cb19-10" data-line-number="10">                                    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="st">"Lrnr_condensier"</span>, <span class="dt">nbins =</span> <span class="dv">30</span>,</a>
<a class="sourceLine" id="cb19-11" data-line-number="11">                                          <span class="dt">bin_estimator =</span> Lrnr_ranger<span class="op">$</span><span class="kw">new</span>(),</a>
<a class="sourceLine" id="cb19-12" data-line-number="12">                                          <span class="dt">bin_method =</span> <span class="st">"equal.len"</span>,</a>
<a class="sourceLine" id="cb19-13" data-line-number="13">                                          <span class="dt">pool =</span> <span class="ot">FALSE</span>),</a>
<a class="sourceLine" id="cb19-14" data-line-number="14">                                    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="st">"Lrnr_condensier"</span>, <span class="dt">nbins =</span> <span class="dv">25</span>,</a>
<a class="sourceLine" id="cb19-15" data-line-number="15">                                          <span class="dt">bin_estimator =</span> Lrnr_ranger<span class="op">$</span><span class="kw">new</span>(),</a>
<a class="sourceLine" id="cb19-16" data-line-number="16">                                          <span class="dt">bin_method =</span> <span class="st">"equal.len"</span>,</a>
<a class="sourceLine" id="cb19-17" data-line-number="17">                                          <span class="dt">pool =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb19-18" data-line-number="18">                                   )</a>
<a class="sourceLine" id="cb19-19" data-line-number="19">sl_lrn_dens &lt;-<span class="st"> </span>Lrnr_sl<span class="op">$</span><span class="kw">new</span>(<span class="dt">learners =</span> lrnr_dens_lib,</a>
<a class="sourceLine" id="cb19-20" data-line-number="20">                           <span class="dt">metalearner =</span> Lrnr_solnp_density<span class="op">$</span><span class="kw">new</span>())</a></code></pre></div>
</div>
<div id="estimating-the-ipcw-tmle-with-optimal-stacked-regressions" class="section level3">
<h3 class="hasAnchor">
<a href="#estimating-the-ipcw-tmle-with-optimal-stacked-regressions" class="anchor"></a>Estimating the IPCW-TMLE with Optimal Stacked Regressions</h3>
<p>Using the framework provided by the <a href="https://sl3.tlverse.org"><code>sl3</code> package</a>, the nuisance parameters of the TML estimator may be fit with ensemble learning, using the cross-validation framework of the Super Learner algorithm of <span class="citation">van der Laan, Polley, and Hubbard (2007)</span>.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1">tmle_sl_shift_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw"><a href="../reference/txshift.html">txshift</a></span>(<span class="dt">W =</span> W, <span class="dt">A =</span> A, <span class="dt">Y =</span> Y,</a>
<a class="sourceLine" id="cb20-2" data-line-number="2">                           <span class="dt">C =</span> C, <span class="dt">V =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"W"</span>, <span class="st">"Y"</span>),</a>
<a class="sourceLine" id="cb20-3" data-line-number="3">                           <span class="dt">delta =</span> delta,</a>
<a class="sourceLine" id="cb20-4" data-line-number="4">                           <span class="dt">fluc_method =</span> <span class="st">"standard"</span>,</a>
<a class="sourceLine" id="cb20-5" data-line-number="5">                           <span class="dt">max_iter =</span> <span class="dv">2</span>,</a>
<a class="sourceLine" id="cb20-6" data-line-number="6">                           <span class="dt">ipcw_fit_args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"sl"</span>,</a>
<a class="sourceLine" id="cb20-7" data-line-number="7">                                                <span class="dt">sl_lrnrs =</span> sl_lrn),</a>
<a class="sourceLine" id="cb20-8" data-line-number="8">                           <span class="dt">g_fit_args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"sl"</span>,</a>
<a class="sourceLine" id="cb20-9" data-line-number="9">                                             <span class="dt">sl_lrnrs =</span> sl_lrn_dens),</a>
<a class="sourceLine" id="cb20-10" data-line-number="10">                           <span class="dt">Q_fit_args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"sl"</span>,</a>
<a class="sourceLine" id="cb20-11" data-line-number="11">                                             <span class="dt">sl_lrnrs =</span> sl_lrn),</a>
<a class="sourceLine" id="cb20-12" data-line-number="12">                           <span class="dt">eif_reg_type =</span> <span class="st">"glm"</span></a>
<a class="sourceLine" id="cb20-13" data-line-number="13">                          )</a></code></pre></div>
<pre><code>## 
## Iter: 1 fn: 2219.4831     Pars:  0.7797160513 0.0000003938 0.2202835553
## Iter: 2 fn: 2219.4831     Pars:  0.77971617672 0.00000003949 0.22028378379
## solnp--&gt; Completed in 2 iterations</code></pre>
<pre><code>## Warning in .subset2(public_bind_env, "initialize")(...): Missing Outcome Data Found. This is okay for prediction, but will likely break training. 
## 
##                You can drop observations with missing outcomes by setting drop_missing_outcome=TRUE in make_sl3_Task

## Warning in .subset2(public_bind_env, "initialize")(...): Missing Outcome Data Found. This is okay for prediction, but will likely break training. 
## 
##                You can drop observations with missing outcomes by setting drop_missing_outcome=TRUE in make_sl3_Task</code></pre>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(tmle_sl_shift_<span class="dv">1</span>)</a></code></pre></div>
<pre><code>##      lwr_ci   param_est      upr_ci   param_var    eif_mean   estimator 
##     0.56939     0.71477     0.86015      0.0055 3.15092e-04        tmle 
##      n_iter 
##           2</code></pre>
<p>As before, we may vary the regression for the submodel fluctuation procedure by weighting each observation by the value of the so-called clever covariate rather than using such an auxiliary covariate directly in the regression procedure:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1">tmle_sl_shift_<span class="dv">2</span> &lt;-<span class="st"> </span><span class="kw"><a href="../reference/txshift.html">txshift</a></span>(<span class="dt">W =</span> W, <span class="dt">A =</span> A, <span class="dt">Y =</span> Y,</a>
<a class="sourceLine" id="cb25-2" data-line-number="2">                           <span class="dt">C =</span> C, <span class="dt">V =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"W"</span>, <span class="st">"Y"</span>),</a>
<a class="sourceLine" id="cb25-3" data-line-number="3">                           <span class="dt">delta =</span> delta,</a>
<a class="sourceLine" id="cb25-4" data-line-number="4">                           <span class="dt">fluc_method =</span> <span class="st">"weighted"</span>,</a>
<a class="sourceLine" id="cb25-5" data-line-number="5">                           <span class="dt">max_iter =</span> <span class="dv">2</span>,</a>
<a class="sourceLine" id="cb25-6" data-line-number="6">                           <span class="dt">ipcw_fit_args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"sl"</span>,</a>
<a class="sourceLine" id="cb25-7" data-line-number="7">                                                <span class="dt">sl_lrnrs =</span> sl_lrn),</a>
<a class="sourceLine" id="cb25-8" data-line-number="8">                           <span class="dt">g_fit_args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"sl"</span>,</a>
<a class="sourceLine" id="cb25-9" data-line-number="9">                                             <span class="dt">sl_lrnrs =</span> sl_lrn_dens),</a>
<a class="sourceLine" id="cb25-10" data-line-number="10">                           <span class="dt">Q_fit_args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"sl"</span>,</a>
<a class="sourceLine" id="cb25-11" data-line-number="11">                                             <span class="dt">sl_lrnrs =</span> sl_lrn),</a>
<a class="sourceLine" id="cb25-12" data-line-number="12">                           <span class="dt">eif_reg_type =</span> <span class="st">"glm"</span></a>
<a class="sourceLine" id="cb25-13" data-line-number="13">                          )</a></code></pre></div>
<pre><code>## 
## Iter: 1 fn: 2063.3205     Pars:  0.7806761920 0.0000003643 0.2193234442
## Iter: 2 fn: 2063.3205     Pars:  0.7806762383 0.0000002302 0.2193235315
## solnp--&gt; Completed in 2 iterations</code></pre>
<pre><code>## Warning in .subset2(public_bind_env, "initialize")(...): Missing Outcome Data Found. This is okay for prediction, but will likely break training. 
## 
##                You can drop observations with missing outcomes by setting drop_missing_outcome=TRUE in make_sl3_Task

## Warning in .subset2(public_bind_env, "initialize")(...): Missing Outcome Data Found. This is okay for prediction, but will likely break training. 
## 
##                You can drop observations with missing outcomes by setting drop_missing_outcome=TRUE in make_sl3_Task</code></pre>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(tmle_sl_shift_<span class="dv">2</span>)</a></code></pre></div>
<pre><code>##      lwr_ci   param_est      upr_ci   param_var    eif_mean   estimator 
##     1.31452     1.49261      1.6707     0.00826 1.84118e-04        tmle 
##      n_iter 
##           2</code></pre>
</div>
<div id="estimating-inefficient-ipcw-tmles-with-optimal-stacked-regressions" class="section level3">
<h3 class="hasAnchor">
<a href="#estimating-inefficient-ipcw-tmles-with-optimal-stacked-regressions" class="anchor"></a>Estimating <em>Inefficient</em> IPCW-TMLEs with Optimal Stacked Regressions</h3>
<p>Utilizing the <code>sl3</code> R package in exactly the same manner, it is also possible to estimate <em>inefficient</em> IPCW-TML estimators with <code>txshift</code>. The inefficient IPCW-TMLE performs nearly all of the same computations as the efficient version of the estimator, eschewing only the iterative targeting procedure performed over a more complex efficient influence function; the interested reader is referred to <span class="citation">Rose and van der Laan (2011)</span> for further details on the differences between the efficient and inefficient IPCW-TMLEs. By default, an efficient IPCW-TMLE is computed when censoring is detected; however, this may be disable by setting the <code>ipcw_efficiency</code> argument to <code>FALSE</code> like so</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" data-line-number="1">tmle_sl_ineffic &lt;-<span class="st"> </span><span class="kw"><a href="../reference/txshift.html">txshift</a></span>(<span class="dt">W =</span> W, <span class="dt">A =</span> A, <span class="dt">Y =</span> Y,</a>
<a class="sourceLine" id="cb30-2" data-line-number="2">                           <span class="dt">C =</span> C, <span class="dt">V =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"W"</span>, <span class="st">"Y"</span>),</a>
<a class="sourceLine" id="cb30-3" data-line-number="3">                           <span class="dt">delta =</span> delta,</a>
<a class="sourceLine" id="cb30-4" data-line-number="4">                           <span class="dt">fluc_method =</span> <span class="st">"standard"</span>,</a>
<a class="sourceLine" id="cb30-5" data-line-number="5">                           <span class="dt">ipcw_fit_args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"sl"</span>,</a>
<a class="sourceLine" id="cb30-6" data-line-number="6">                                                <span class="dt">sl_lrnrs =</span> sl_lrn),</a>
<a class="sourceLine" id="cb30-7" data-line-number="7">                           <span class="dt">g_fit_args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"sl"</span>,</a>
<a class="sourceLine" id="cb30-8" data-line-number="8">                                             <span class="dt">sl_lrnrs =</span> sl_lrn_dens),</a>
<a class="sourceLine" id="cb30-9" data-line-number="9">                           <span class="dt">Q_fit_args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"sl"</span>,</a>
<a class="sourceLine" id="cb30-10" data-line-number="10">                                             <span class="dt">sl_lrnrs =</span> sl_lrn),</a>
<a class="sourceLine" id="cb30-11" data-line-number="11">                           <span class="dt">ipcw_efficiency =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb30-12" data-line-number="12">                          )</a></code></pre></div>
<pre><code>## 
## Iter: 1 fn: 1934.8745     Pars:  0.69140 0.06043 0.24818
## Iter: 2 fn: 1934.8745     Pars:  0.69140 0.06043 0.24818
## solnp--&gt; Completed in 2 iterations</code></pre>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(tmle_sl_ineffic)</a></code></pre></div>
<pre><code>##      lwr_ci   param_est      upr_ci   param_var    eif_mean   estimator 
##       1.884     2.09518     2.30635     0.01161 3.07120e-11        tmle 
##      n_iter 
##           0</code></pre>
<p>Please note that in such cases, the value of <code>n_iter</code> in the resulting output should be <strong><em>exactly zero</em></strong>, as this indicates that the iterative procedure that is used to achieve efficiency has been skipped.</p>
</div>
<div id="statistical-inference-for-targeted-maximum-likelihood-estimates" class="section level3">
<h3 class="hasAnchor">
<a href="#statistical-inference-for-targeted-maximum-likelihood-estimates" class="anchor"></a>Statistical Inference for Targeted Maximum Likelihood Estimates</h3>
<p>For a discussion of the procedure for obtaining statistical inference for TML estimators, the interested reader is referred to the introductory vignette of this package. Here, we focus on addressing the issue of how censoring impacts the inferential procedure…</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" data-line-number="1">(ci_shift &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/confint">confint</a></span>(tmle_sl_shift_<span class="dv">1</span>))</a></code></pre></div>
<pre><code>##    lwr_ci       est    upr_ci 
## 0.5693862 0.7147671 0.8601481</code></pre>
<hr>
</div>
</div>
<div id="advanced-usage-user-specified-regressions" class="section level2">
<h2 class="hasAnchor">
<a href="#advanced-usage-user-specified-regressions" class="anchor"></a><em>Advanced Usage:</em> User-Specified Regressions</h2>
<p>In some special cases it may be useful for the experienced user to compute the censoring mechanism, treatment mechanism, and outcome mechanism regressions separately (i.e., outside of the <code>txshift</code> wrapper function), instead applying this user-facing wrapper only to invoke the <em>targeting</em> steps involved in computing the TML estimator for the treatment shift parameter. In such cases, the optional arguments <code>ipcw_fit_spec</code>, <code>gn_fit_spec</code> and <code>Qn_fit_spec</code> may be utilized. We present a case of using these arguments here:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" data-line-number="1"><span class="co"># compute the censoring mechanism and produce IPC weights externally</span></a>
<a class="sourceLine" id="cb36-2" data-line-number="2">pi_mech &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Logistic">plogis</a></span>(W)</a>
<a class="sourceLine" id="cb36-3" data-line-number="3">ipc_weights_out &lt;-<span class="st"> </span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(C <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) <span class="op">/</span><span class="st"> </span>pi_mech)[C <span class="op">==</span><span class="st"> </span><span class="dv">1</span>]</a>
<a class="sourceLine" id="cb36-4" data-line-number="4">ipcw_out &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">pi_mech =</span> pi_mech, <span class="dt">ipc_weights =</span> ipc_weights_out)</a>
<a class="sourceLine" id="cb36-5" data-line-number="5"></a>
<a class="sourceLine" id="cb36-6" data-line-number="6"><span class="co"># compute treatment mechanism (propensity score) externally</span></a>
<a class="sourceLine" id="cb36-7" data-line-number="7">## first, produce the down-shifted treatment data</a>
<a class="sourceLine" id="cb36-8" data-line-number="8">gn_downshift &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">dnorm</a></span>(A <span class="op">-</span><span class="st"> </span>delta, <span class="dt">mean =</span> tx_mult <span class="op">*</span><span class="st"> </span>W, <span class="dt">sd =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb36-9" data-line-number="9">## next, initialize and produce the up-shifted treatment data</a>
<a class="sourceLine" id="cb36-10" data-line-number="10">gn_upshift &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">dnorm</a></span>(A <span class="op">+</span><span class="st"> </span>delta, <span class="dt">mean =</span> tx_mult <span class="op">*</span><span class="st"> </span>W, <span class="dt">sd =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb36-11" data-line-number="11">## now, initialize and produce the up-up-shifted (2 * delta) treatment data</a>
<a class="sourceLine" id="cb36-12" data-line-number="12">gn_upupshift &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">dnorm</a></span>(A <span class="op">+</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>delta, <span class="dt">mean =</span> tx_mult <span class="op">*</span><span class="st"> </span>W, <span class="dt">sd =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb36-13" data-line-number="13">## then, initialize and produce the un-shifted treatment data</a>
<a class="sourceLine" id="cb36-14" data-line-number="14">gn_noshift &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">dnorm</a></span>(A, <span class="dt">mean =</span> tx_mult <span class="op">*</span><span class="st"> </span>W, <span class="dt">sd =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb36-15" data-line-number="15">## finally, put it all together into an object like what's produced internally</a>
<a class="sourceLine" id="cb36-16" data-line-number="16">gn_out &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/data.table/topics/as.data.table">as.data.table</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(gn_downshift, gn_noshift, gn_upshift,</a>
<a class="sourceLine" id="cb36-17" data-line-number="17">                              gn_upupshift))[C <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, ]</a>
<a class="sourceLine" id="cb36-18" data-line-number="18"><span class="kw"><a href="https://www.rdocumentation.org/packages/data.table/topics/setattr">setnames</a></span>(gn_out, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"downshift"</span>, <span class="st">"noshift"</span>, <span class="st">"upshift"</span>, <span class="st">"upupshift"</span>))</a>
<a class="sourceLine" id="cb36-19" data-line-number="19"></a>
<a class="sourceLine" id="cb36-20" data-line-number="20"><span class="co"># compute outcome regression externally</span></a>
<a class="sourceLine" id="cb36-21" data-line-number="21">Qn_noshift &lt;-<span class="st"> </span>(W <span class="op">+</span><span class="st"> </span>A <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">min</a></span>(Y)) <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/diff">diff</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/range">range</a></span>(Y))</a>
<a class="sourceLine" id="cb36-22" data-line-number="22">Qn_upshift &lt;-<span class="st"> </span>(W <span class="op">+</span><span class="st"> </span>A <span class="op">+</span><span class="st"> </span>delta <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">min</a></span>(Y)) <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/diff">diff</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/range">range</a></span>(Y))</a>
<a class="sourceLine" id="cb36-23" data-line-number="23">Qn_noshift[Qn_noshift <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>] &lt;-<span class="st"> </span>.Machine<span class="op">$</span>double.neg.eps</a>
<a class="sourceLine" id="cb36-24" data-line-number="24">Qn_noshift[Qn_noshift <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>] &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span>.Machine<span class="op">$</span>double.neg.eps</a>
<a class="sourceLine" id="cb36-25" data-line-number="25">Qn_upshift[Qn_upshift <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>] &lt;-<span class="st"> </span>.Machine<span class="op">$</span>double.neg.eps</a>
<a class="sourceLine" id="cb36-26" data-line-number="26">Qn_upshift[Qn_upshift <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>] &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span>.Machine<span class="op">$</span>double.neg.eps</a>
<a class="sourceLine" id="cb36-27" data-line-number="27">Qn_out &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/data.table/topics/as.data.table">as.data.table</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(Qn_noshift, Qn_upshift))[C <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, ]</a>
<a class="sourceLine" id="cb36-28" data-line-number="28"><span class="kw"><a href="https://www.rdocumentation.org/packages/data.table/topics/setattr">setnames</a></span>(Qn_out, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"noshift"</span>, <span class="st">"upshift"</span>))</a>
<a class="sourceLine" id="cb36-29" data-line-number="29"></a>
<a class="sourceLine" id="cb36-30" data-line-number="30"><span class="co"># invoke the wrapper function only to apply the targeting step</span></a>
<a class="sourceLine" id="cb36-31" data-line-number="31">tmle_shift_spec &lt;-<span class="st"> </span><span class="kw"><a href="../reference/txshift.html">txshift</a></span>(<span class="dt">W =</span> W, <span class="dt">A =</span> A, <span class="dt">Y =</span> Y, <span class="dt">delta =</span> delta,</a>
<a class="sourceLine" id="cb36-32" data-line-number="32">                           <span class="dt">C =</span> C, <span class="dt">V =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"W"</span>, <span class="st">"Y"</span>),</a>
<a class="sourceLine" id="cb36-33" data-line-number="33">                           <span class="dt">fluc_method =</span> <span class="st">"standard"</span>,</a>
<a class="sourceLine" id="cb36-34" data-line-number="34">                           <span class="dt">max_iter =</span> <span class="dv">2</span>,</a>
<a class="sourceLine" id="cb36-35" data-line-number="35">                           <span class="dt">ipcw_fit_args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"fit_spec"</span>),</a>
<a class="sourceLine" id="cb36-36" data-line-number="36">                           <span class="dt">g_fit_args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"fit_spec"</span>),</a>
<a class="sourceLine" id="cb36-37" data-line-number="37">                           <span class="dt">Q_fit_args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">fit_type =</span> <span class="st">"fit_spec"</span>),</a>
<a class="sourceLine" id="cb36-38" data-line-number="38">                           <span class="dt">ipcw_fit_spec =</span> ipcw_out,</a>
<a class="sourceLine" id="cb36-39" data-line-number="39">                           <span class="dt">gn_fit_spec =</span> gn_out,</a>
<a class="sourceLine" id="cb36-40" data-line-number="40">                           <span class="dt">Qn_fit_spec =</span> Qn_out,</a>
<a class="sourceLine" id="cb36-41" data-line-number="41">                           <span class="dt">eif_reg_type =</span> <span class="st">"glm"</span>)</a>
<a class="sourceLine" id="cb36-42" data-line-number="42"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(tmle_shift_spec)</a></code></pre></div>
<pre><code>##      lwr_ci   param_est      upr_ci   param_var    eif_mean   estimator 
##     1.21061     1.36916     1.52771     0.00654 2.67204e-06        tmle 
##      n_iter 
##           2</code></pre>
<hr>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-diaz2018stochastic">
<p>Díaz, Iván, and Mark J van der Laan. 2018. “Stochastic Treatment Regimes.” In <em>Targeted Learning in Data Science: Causal Inference for Complex Longitudinal Studies</em>, 167–80. Springer Science &amp; Business Media.</p>
</div>
<div id="ref-rose2011targeted2sd">
<p>Rose, Sherri, and Mark J van der Laan. 2011. “A Targeted Maximum Likelihood Estimator for Two-Stage Designs.” <em>The International Journal of Biostatistics</em> 7 (1): 1–21.</p>
</div>
<div id="ref-vdl2007super">
<p>van der Laan, Mark J, Eric C Polley, and Alan E Hubbard. 2007. “Super Learner.” <em>Statistical Applications in Genetics and Molecular Biology</em> 6 (1).</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#data-and-notation">Data and Notation</a></li>
      <li><a href="#methodology">Methodology</a></li>
      <li><a href="#advanced-usage-user-specified-regressions"><em>Advanced Usage:</em> User-Specified Regressions</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Nima Hejazi, David Benkeser.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
